<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FRoneX Livonia Danger Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .city-label{font-weight:900;font-size:14px;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.85);background:transparent;border:none;box-shadow:none;}
    .city-label.low{color:#b9ffcc;} .city-label.med{color:#ffd28a;} .city-label.ext{color:#ffb0b0;}
    .legend{background:rgba(0,0,0,.75);color:#fff;padding:12px 14px;border-radius:12px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;font-size:14px;line-height:1.35;box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:360px;}
    .legend h3{margin:0 0 10px;font-size:15px;}
    .row{display:flex;align-items:center;gap:10px;margin:7px 0;}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block;}
  </style>
</head>
<body>
<div id="map"></div>

<script>
  // --- IMPORTANT SIZES ---
  // DayZ world coordinates are 0..15360.
  // Your TILE image is 18K, so pixel-space is 0..18000.
  const DAYZ_SIZE  = 15360;
  const IMAGE_SIZE = 18000;
  const SCALE = IMAGE_SIZE / DAYZ_SIZE;

  // must match the folders you actually have in /tiles (0..5 or 0..6)
  const MAX_ZOOM = 5;
  const TILE_SIZE = 256;

  const COLORS = { WARDENS:"#2ecc71", RANGERS:"#ff9f1a", RAIDERS:"#ff3b30" };

  // Leaflet CRS.Simple expects (y,x) order.
  const bounds = L.latLngBounds([[0,0],[IMAGE_SIZE, IMAGE_SIZE]]);

  const map = L.map("map", {
    crs: L.CRS.Simple,
    minZoom: 0,
    maxZoom: MAX_ZOOM,
    zoomSnap: 0.25,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0
  });

  // Fit to full map
  map.fitBounds(bounds);

  // Tiles (XYZ). If you still get negative y, set tms:true.
  const livoniaTiles = L.tileLayer("./tiles/{z}/{x}/{y}.jpg", {
    minZoom: 0,
    maxZoom: MAX_ZOOM,
    tileSize: TILE_SIZE,
    noWrap: true,
    bounds: bounds,
    tms: false
  }).addTo(map);

  // Layers
  const wardensLayer = L.layerGroup().addTo(map);
  const rangersLayer = L.layerGroup().addTo(map);
  const raidersLayer = L.layerGroup().addTo(map);
  const cityLabelsLayer = L.layerGroup().addTo(map);

  function labelClass(tier){
    if (tier==="LOW") return "city-label low";
    if (tier==="MEDIUM") return "city-label med";
    return "city-label ext";
  }

  // Convert DayZ coords (X/Z) -> tile coords
  function p(x, z){ return [z*SCALE, x*SCALE]; }

  const zones = [
    { name:"Brena", faction:"Blackwood Rangers", tier:"MEDIUM", color:COLORS.RANGERS, x:6467, z:11354, radius:500, ai:5 },
    { name:"Sitnik", faction:"Blackwood Rangers", tier:"MEDIUM", color:COLORS.RANGERS, x:11634, z:9605, radius:200, ai:5 },
    { name:"Topolin", faction:"Blackwood Rangers", tier:"MEDIUM", color:COLORS.RANGERS, x:1524, z:7412, radius:500, ai:5 },
    { name:"Nadbor", faction:"Blackwood Rangers", tier:"MEDIUM", color:COLORS.RANGERS, x:5959, z:4113, radius:500, ai:5 },

    { name:"Glinishka", faction:"Livonian Wardens", tier:"LOW", color:COLORS.WARDENS, x:4999, z:9955, radius:200, ai:3 },
    { name:"Zalesie", faction:"Livonian Wardens", tier:"LOW", color:COLORS.WARDENS, x:907, z:5550, radius:200, ai:3 },
    { name:"Lukow", faction:"Livonian Wardens", tier:"LOW", color:COLORS.WARDENS, x:3632, z:11774, radius:200, ai:3 },
    { name:"Polana", faction:"Livonian Wardens", tier:"LOW", color:COLORS.WARDENS, x:3360, z:2018, radius:200, ai:3 },

    { name:"Bunker", faction:"Ironfang Raiders", tier:"EXTREME", color:COLORS.RAIDERS, x:715, z:1144, radius:320, ai:8 }
  ];

  function popupHTML(z){
    return `<div style="font-family:system-ui;min-width:230px">
      <div style="font-size:16px;font-weight:900;margin-bottom:6px">${z.name}</div>
      <div><b>Faction:</b> ${z.faction}</div>
      <div><b>AI:</b> ${z.ai}</div>
      <div><b>Radius:</b> ${z.radius} m</div>
      <div><b>Coords:</b> X${z.x} Z${z.z}</div>
    </div>`;
  }

  function renderZone(z, layer){
    const center = p(z.x, z.z);

    L.circle(center, {
      radius: z.radius * SCALE,
      color: z.color,
      weight: 2,
      opacity: 0.9,
      fillColor: z.color,
      fillOpacity: 0.18
    }).addTo(layer);

    L.circleMarker(center, {
      radius: 7,
      color: z.color,
      fillColor: z.color,
      fillOpacity: 1,
      weight: 2
    }).addTo(layer).bindPopup(popupHTML(z));

    L.marker(center, {interactive:false, opacity:0.95})
      .bindTooltip(z.name, {permanent:true, direction:"center", className: labelClass(z.tier)})
      .addTo(cityLabelsLayer);
  }

  zones.forEach(z=>{
    if (z.faction==="Livonian Wardens") renderZone(z, wardensLayer);
    else if (z.faction==="Blackwood Rangers") renderZone(z, rangersLayer);
    else renderZone(z, raidersLayer);
  });

  // Layer toggles
  const overlays = {
    "üè∑Ô∏è City Names (labels)": cityLabelsLayer,
    "üü¢ Livonian Wardens (LOW)": wardensLayer,
    "üü† Blackwood Rangers (MEDIUM)": rangersLayer,
    "üî¥ Ironfang Raiders (EXTREME / Bunker)": raidersLayer
  };
  L.control.layers({}, overlays, {collapsed:false}).addTo(map);

  // Legend
  const legend=L.control({position:"bottomleft"});
  legend.onAdd=function(){
    const div=L.DomUtil.create("div","legend");
    div.innerHTML=`<h3>FRoneX ‚Äì Livonia Danger Map</h3>
    <div class="row"><span class="dot" style="background:${COLORS.WARDENS}"></span><div><b>Livonian Wardens</b><br/>LOW threat</div></div>
    <div class="row"><span class="dot" style="background:${COLORS.RANGERS}"></span><div><b>Blackwood Rangers</b><br/>MEDIUM threat</div></div>
    <div class="row"><span class="dot" style="background:${COLORS.RAIDERS}"></span><div><b>Ironfang Raiders</b><br/>EXTREME threat</div></div>
    <div style="opacity:.85;font-size:12px;margin-top:10px">If tiles still 404 with negative Y, set <b>tms:true</b>.</div>`;
    return div;
  };
  legend.addTo(map);
</script>
</body>
</html>
