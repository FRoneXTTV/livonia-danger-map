<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Livonia AI Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; background:#0b0f14; }
    #map { height: 100%; width: 100%; }
    .leaflet-control-layers { font-size: 14px; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ==== CONFIG ====
  const IMAGE_SIZE = 18000;        // full map size in pixels (square)
  const TILE_SIZE = 256;
  const MIN_ZOOM = 0;
  const MAX_ZOOM = 6;              // your chosen cap
  const MAX_NATIVE_ZOOM = 6;       // highest zoom level that has real tiles
  const TILE_URL = "./tiles/{z}/{x}/{y}.jpg";

  // ==== MAP ====
  const map = L.map("map", {
    crs: L.CRS.Simple,
    minZoom: MIN_ZOOM,
    maxZoom: MAX_ZOOM,
    zoomControl: true,
    attributionControl: false,
    preferCanvas: true
  });

  // bounds (pixel space) -> latlng space
  const southWest = map.unproject([0, IMAGE_SIZE], MAX_NATIVE_ZOOM);
  const northEast = map.unproject([IMAGE_SIZE, 0], MAX_NATIVE_ZOOM);
  const bounds = L.latLngBounds(southWest, northEast);

  // Base tiles
  const base = L.tileLayer(TILE_URL, {
    tileSize: TILE_SIZE,
    noWrap: true,
    bounds: bounds,
    tms: true,                 // âœ… fixes negative Y if your tiles are TMS
    maxNativeZoom: MAX_NATIVE_ZOOM,
    maxZoom: MAX_ZOOM,
    minZoom: MIN_ZOOM,
    keepBuffer: 4,
    updateWhenIdle: true,
    updateWhenZooming: false
  });

  base.addTo(map);

  map.setMaxBounds(bounds.pad(0.05));
  map.fitBounds(bounds);

  // ==== LAYERS ====
  const layerLabels  = L.layerGroup();
  const layerFactions = L.layerGroup();
  const layerRoutes  = L.layerGroup();
  const layerPOI     = L.layerGroup();

  // Example marker styles (simple circles)
  function addPOI(name, xy, layer) {
    const latlng = map.unproject(xy, MAX_NATIVE_ZOOM);
    L.circleMarker(latlng, { radius: 6 })
      .bindTooltip(name, { direction: "top", offset: [0, -6] })
      .addTo(layer);
  }

  // POI examples (xy in pixels!)
  addPOI("Nadbor Police",  [10245, 8756], layerPOI);
  addPOI("Nadbor Med",     [10180, 8890], layerPOI);

  // Route example polyline
  function addRoute(name, pointsXY, layer) {
    const pts = pointsXY.map(p => map.unproject(p, MAX_NATIVE_ZOOM));
    L.polyline(pts, { weight: 3 })
      .bindTooltip(name)
      .addTo(layer);
  }

  addRoute("Nadbor Street Loop 01", [
    [10080, 8730],
    [10320, 8740],
    [10460, 8900],
    [10270, 9050],
    [10060, 8920]
  ], layerRoutes);

  // Faction zones example (circles)
  function addZone(name, centerXY, radiusPx, layer) {
    const center = map.unproject(centerXY, MAX_NATIVE_ZOOM);
    // radius in CRS.Simple is in map units; convert pixels->map units:
    // easiest: approximate by unproject shift
    const edge = map.unproject([centerXY[0] + radiusPx, centerXY[1]], MAX_NATIVE_ZOOM);
    const r = center.distanceTo(edge);

    L.circle(center, { radius: r, weight: 2, fillOpacity: 0.15 })
      .bindTooltip(name)
      .addTo(layer);
  }

  addZone("Wardens Guards (PD)", [10245, 8756], 90, layerFactions);
  addZone("Rangers Patrol", [10220, 8800], 650, layerFactions);

  // Enable some layers by default
  layerPOI.addTo(map);
  layerRoutes.addTo(map);

  // Layer control
  const overlays = {
    "POI": layerPOI,
    "Routes": layerRoutes,
    "Factions/Zones": layerFactions,
    "Labels": layerLabels
  };

  L.control.layers(null, overlays, { collapsed: false }).addTo(map);

  // Debug: prevent requests outside bounds (extra safety)
  map.on("moveend zoomend", () => {
    const c = map.getCenter();
    if (!bounds.contains(c)) map.panInsideBounds(bounds, { animate: false });
  });
</script>
</body>
</html>
